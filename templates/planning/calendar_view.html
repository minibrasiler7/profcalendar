{% extends "base.html" %}

{% block title %}Calendrier - TeacherPlanner{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/calendar.css') }}">
<!-- PDF.js pour l'affichage des PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
// Configuration du worker PDF.js
if (typeof pdfjsLib !== 'undefined') {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
}
</script>
<style>
/* Styles pour le modal de planification avec gestionnaire de fichiers */
.planning-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
    overflow-y: auto;
    padding: 2rem 0;
}

.planning-modal.show {
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 5vh;
}

.planning-modal .modal-content {
    background-color: var(--white);
    border-radius: var(--border-radius);
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
    animation: slideUp 0.3s ease-out;
    position: relative;
    margin: 0 auto;
}

.planning-modal.split-view {
    background: none;
}

.planning-modal.split-view .modal-content {
    width: 500px;
    position: fixed;
    left: calc(50% - 510px);
    top: 5vh;
}

.file-manager-panel {
    position: fixed;
    top: 5vh;
    left: calc(50% - 10px);
    width: 500px;
    height: 90vh;
    max-height: 90vh;
    background-color: white;
    border: 1px solid #e5e7eb;
    border-radius: var(--border-radius);
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    z-index: 1001;
}

.file-manager-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    background-color: white;
    border-bottom: 1px solid #e5e7eb;
}

.file-manager-header h3 {
    margin: 0;
    font-size: 1.125rem;
    color: #1f2937;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.file-manager-content {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
}

.modal-header-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.btn-icon {
    background: none;
    border: none;
    padding: 0.5rem;
    cursor: pointer;
    border-radius: 0.375rem;
    color: #6b7280;
    transition: all 0.2s;
}

.btn-icon:hover {
    background-color: #f3f4f6;
    color: #1f2937;
}

.file-loading {
    text-align: center;
    padding: 3rem;
    color: #6b7280;
}

.file-navigation {
    margin-bottom: 1rem;
}

.breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: #6b7280;
}

.breadcrumb-item {
    cursor: pointer;
    transition: color 0.2s;
}

.breadcrumb-item:hover {
    color: var(--primary-color);
}

.breadcrumb-item.active {
    color: #1f2937;
    font-weight: 500;
}

.file-tree {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.file-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: background-color 0.2s;
}

.file-item:hover {
    background-color: #e5e7eb;
}

.file-item.folder {
    font-weight: 500;
}

.file-icon {
    font-size: 1.125rem;
    width: 20px;
    text-align: center;
}

.file-icon.fa-folder {
    color: #f59e0b;
}

.file-icon.fa-file-pdf {
    color: #dc2626;
}

.file-icon.fa-file-image {
    color: #10b981;
}

.file-name {
    flex: 1;
    font-size: 0.875rem;
    color: #374151;
}

.no-files {
    text-align: center;
    padding: 3rem;
    color: #9ca3af;
}

.no-files i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

/* Styles pour le Modal Viewer/Annotateur */
.file-viewer-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.95);
    z-index: 10000;
    display: none;
    flex-direction: column;
}

.file-viewer-modal.show {
    display: flex;
}

/* Mode intégré pour le viewer dans la vue split */
.file-viewer-modal.embedded {
    position: fixed;
    top: 5vh;
    left: calc(50% - 10px);
    width: 500px;
    height: 90vh;
    background-color: rgba(0, 0, 0, 0.95);
    z-index: 1001;
    border-radius: var(--border-radius);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.file-viewer-modal.embedded .viewer-header {
    background-color: #2d3748;
    color: white;
    border-radius: var(--border-radius) var(--border-radius) 0 0;
}

.viewer-header {
    background-color: #f8fafc;
    color: #2d3748;
    padding: 0.75rem 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #e2e8f0;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    z-index: 1;
    position: relative;
}

.viewer-title {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 0.95rem;
    font-weight: 500;
}

.viewer-tools {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    flex-wrap: nowrap;
}

.tool-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding-right: 1.5rem;
    border-right: 1px solid #e2e8f0;
}

.tool-group:last-child {
    border-right: none;
    padding-right: 0;
}

.tool-btn {
    width: 40px;
    height: 40px;
    border: 1px solid #e2e8f0;
    background-color: #ffffff;
    color: #4a5568;
    border-radius: 0.5rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.tool-btn:hover {
    background-color: #f7fafc;
    border-color: #cbd5e0;
    transform: translateY(-1px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
}

.tool-btn.active {
    background-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
}

.color-picker-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background-color: #ffffff;
    padding: 0.5rem;
    border-radius: 0.5rem;
    border: 1px solid #e2e8f0;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    position: relative;
    z-index: 1;
}

.preset-colors {
    display: flex;
    gap: 0.25rem;
    align-items: center;
}

.color-btn {
    width: 28px;
    height: 28px;
    border: 2px solid transparent;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    z-index: 1;
}

.color-btn:hover {
    transform: scale(1.1);
    border-color: white;
}

.color-btn.active {
    border-color: white;
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
}

.color-picker-container input[type="color"] {
    width: 32px;
    height: 32px;
    border: 2px solid transparent;
    border-radius: 0.5rem;
    cursor: pointer;
    background: none;
}

.stroke-width-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background-color: #4A5568;
    padding: 0.5rem;
    border-radius: 0.5rem;
    position: relative;
    z-index: 10;
}

.stroke-width-container input[type="range"] {
    width: 80px;
    -webkit-appearance: none;
    appearance: none;
    height: 6px;
    background: #6B7280;
    outline: none;
    border-radius: 3px;
    cursor: pointer;
}

.stroke-width-container input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    background: #fff;
    cursor: pointer;
    border-radius: 50%;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

#strokeWidthValue {
    min-width: 20px;
    text-align: center;
    font-size: 0.9rem;
}

.close-viewer {
    width: 40px;
    height: 40px;
    border: none;
    background-color: #e53e3e;
    color: white;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.close-viewer:hover {
    background-color: #c53030;
}

.viewer-content {
    display: flex;
    flex: 1;
    overflow: hidden;
}

.page-sidebar {
    width: 200px;
    background-color: #2d3748;
    color: white;
    overflow-y: auto;
    border-right: 1px solid #4a5568;
}

.sidebar-header {
    padding: 1rem;
    border-bottom: 1px solid #4a5568;
}

.sidebar-header h6 {
    margin: 0;
    font-size: 0.875rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.page-thumbnails {
    padding: 0.5rem;
    max-height: calc(100vh - 200px);
    overflow-y: auto;
}

.viewer-container {
    flex: 1;
    background-color: #1a202c;
    overflow: auto;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 2rem;
}

.pdf-pages-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    max-width: 100%;
}

.viewer-footer {
    background-color: #2d3748;
    color: white;
    padding: 0.5rem 2rem;
    text-align: center;
    border-top: 1px solid #4a5568;
}

.save-status {
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

/* Overlay pour les modals */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 999;
}

/* Styles additionnels pour les indicateurs de checklist */
.checklist-summary {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.65rem;
    margin-top: 0.125rem;
}

.checklist-icon {
    font-size: 0.75rem;
}

.checklist-icon.all-checked {
    color: #10B981;
}

.checklist-icon.partial {
    color: #F59E0B;
}

.checklist-icon.none-checked {
    color: #EF4444;
}

.checklist-count {
    color: rgba(255, 255, 255, 0.8);
    font-weight: 500;
}

/* Pour la vue annuelle */
.annual-planning-checklist {
    display: flex;
    align-items: center;
    gap: 0.125rem;
    font-size: 0.5rem;
    margin-bottom: 0.125rem;
}

.annual-checklist-icon {
    font-size: 0.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="calendar-container">
    <!-- En-tête avec navigation -->
    <div class="calendar-header">
        <div class="calendar-nav">
            <button class="nav-btn" onclick="navigateWeek('prev')">
                <i class="fas fa-chevron-left"></i>
            </button>

            <h2 class="current-week-title">
                Semaine du {{ week_dates[0] | format_date_full }} au {{ week_dates[4] | format_date }}
            </h2>

            <button class="nav-btn" onclick="navigateWeek('next')">
                <i class="fas fa-chevron-right"></i>
            </button>

            <button class="btn btn-primary btn-today" onclick="navigateToToday()">
                <i class="fas fa-calendar-day"></i> Aujourd'hui
            </button>

            <button class="btn btn-outline btn-toggle-view" onclick="toggleViewMode()" title="Basculer la vue">
                <i class="fas fa-expand-alt" id="toggleIcon"></i>
                <span id="toggleText">Vue étendue</span>
            </button>
        </div>
    </div>

    <!-- Conteneur principal avec deux colonnes -->
    <div class="calendar-main">
        <!-- Vue hebdomadaire -->
        <div class="weekly-view">
            <div class="weekly-view-loading">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
            </div>
            <h3 class="section-title">
                <i class="fas fa-calendar-week"></i> Vue hebdomadaire
            </h3>

            <div class="weekly-schedule">
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th class="time-column">Heure</th>
                            {% for date in week_dates %}
                            <th class="day-header {% if date == today %}today{% endif %}">
                                <div class="day-name">{{ days[loop.index0] }}</div>
                                <div class="day-date">{{ date.strftime('%d/%m') }}</div>
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for period in periods %}
                        <tr>
                            <td class="time-slot">
                                <div class="period-number">P{{ period.number }}</div>
                                <div class="period-time">
                                    {{ period.start.strftime('%H:%M') }}<br>
                                    {{ period.end.strftime('%H:%M') }}
                                </div>
                            </td>
                            {% for date in week_dates %}
                            {% set i = loop.index0 %}
                            <td class="schedule-cell {% if date == today %}today{% endif %}"
                                data-date="{{ date.strftime('%Y-%m-%d') }}"
                                data-period="{{ period.number }}"
                                onclick="openPlanningModal(this)">

                                {% set planning_key = date.strftime('%Y-%m-%d') + '_' + period.number|string %}
                                {% set schedule_key = i|string + '_' + period.number|string %}
                                {% set holiday_info = holidays_info[date.strftime('%Y-%m-%d')] %}

                                {% if holiday_info.is_holiday %}
                                    <!-- Jour férié -->
                                    <div class="holiday-block">
                                        <div class="holiday-day-name">{{ holiday_info.name }}</div>
                                    </div>
                                {% elif date >= current_user.school_year_start and date <= current_user.school_year_end %}
                                    {% if planning_key in planning_grid %}
                                        <!-- Planification spécifique -->
                                        {% set planning = planning_grid[planning_key] %}
                                        <div class="class-block planned" style="background-color: {{ planning.classroom.color }};">
                                            <div class="class-name">{{ planning.classroom.name }}</div>
                                            <div class="class-subject">{{ planning.classroom.subject }}</div>
                                            {% if planning.title %}
                                            <div class="planning-title">
                                                {{ planning.title }}
                                            </div>
                                            {% endif %}
                                            {% if planning.checklist_summary %}
                                            <div class="checklist-summary">
                                                {% if planning.checklist_summary.all_checked %}
                                                    <i class="fas fa-check-circle checklist-icon all-checked"></i>
                                                {% elif planning.checklist_summary.checked > 0 %}
                                                    <i class="fas fa-tasks checklist-icon partial"></i>
                                                {% else %}
                                                    <i class="fas fa-times-circle checklist-icon none-checked"></i>
                                                {% endif %}
                                                <span class="checklist-count">{{ planning.checklist_summary.checked }}/{{ planning.checklist_summary.total }}</span>
                                            </div>
                                            {% endif %}
                                        </div>
                                    {% elif schedule_key in schedule_grid %}
                                        <!-- Horaire type -->
                                        {% set schedule = schedule_grid[schedule_key] %}
                                        <div class="class-block" style="background-color: {{ schedule.classroom.color }}; opacity: 0.7;">
                                            <div class="class-name">{{ schedule.classroom.name }}</div>
                                            <div class="class-subject">{{ schedule.classroom.subject }}</div>
                                        </div>
                                    {% endif %}
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Vue annuelle par classe -->
        <div class="annual-view">
            <h3 class="section-title">
                <i class="fas fa-calendar-alt"></i> Vue annuelle
            </h3>

            <!-- Onglets des classes -->
            <div class="class-tabs">
                {% for classroom in classrooms %}
                <button class="tab-btn {% if classroom.id == selected_classroom_id %}active{% endif %}"
                        onclick="selectClassroom({{ classroom.id }})"
                        style="border-bottom-color: {{ classroom.color }};">
                    {{ classroom.name }}
                </button>
                {% endfor %}
            </div>

            <!-- Calendrier annuel -->
            <div class="annual-calendar">
                {% if selected_classroom_id and selected_classroom_id in annual_data %}
                    {% set selected_classroom = classrooms | selectattr('id', 'equalto', selected_classroom_id) | first %}
                    <div class="annual-grid" data-classroom-color="{{ selected_classroom.color if selected_classroom else '#4F46E5' }}">
                        {% for week in annual_data[selected_classroom_id] %}
                        <div class="annual-week {% if week.start_date <= today and today <= week.dates[4] %}current-week{% endif %} {% if week.is_holiday %}holiday-week{% endif %}">
                            <div class="week-info">
                                <div class="week-date">{{ week.formatted_date }}</div>
                                <div class="week-number" {% if not week.is_holiday %}onclick="navigateToWeek('{{ week.start_date.strftime('%Y-%m-%d') }}')" title="Cliquez pour voir cette semaine"{% endif %}>
                                    {% if week.is_holiday %}
                                        <span class="holiday-label" title="{{ week.holiday_name }}">
                                            {% if week.holiday_name_short %}
                                                {{ week.holiday_name_short }}
                                            {% else %}
                                                {% set holiday_parts = week.holiday_name.split(' ') %}
                                                {% if holiday_parts|length > 1 and week.holiday_name|length > 12 %}
                                                    {{ holiday_parts[0] }}<br>{{ holiday_parts[1:] | join(' ') }}
                                                {% else %}
                                                    {{ week.holiday_name }}
                                                {% endif %}
                                            {% endif %}
                                        </span>
                                    {% else %}
                                        <span class="week-number-link">S{{ week.week_number }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="week-days">
                                {% for has_class in week.has_class %}
                                {% set i = loop.index0 %}
                                {% set date = week.dates[i] %}
                                {% set date_str = date.strftime('%Y-%m-%d') %}
                                {% set holiday_name = week.holidays_by_day[i] %}
                                <div class="annual-day {% if has_class %}has-class{% endif %} {% if date == today %}today{% endif %} {% if holiday_name %}holiday single-day-holiday{% endif %}"
                                     data-date="{{ date_str }}"
                                     data-weekday="{{ i }}"
                                     data-has-class="{{ 'true' if has_class else 'false' }}"
                                     onclick="{% if has_class and not holiday_name %}handleAnnualDayClick(this, '{{ date_str }}'){% endif %}"
                                     title="{{ days[i] }} {{ date.strftime('%d/%m') }}{% if holiday_name %} - {{ holiday_name }}{% endif %}">
                                    <div class="annual-day-content">
                                        {% if holiday_name %}
                                            <div class="annual-holiday-name">{{ holiday_name[:3] }}</div>
                                        {% elif week.plannings and date_str in week.plannings %}
                                            <div class="annual-plannings">
                                                {% for planning in week.plannings[date_str][:3] %}
                                                    <div class="annual-planning-item" title="{{ planning.title }}">
                                                        {% if planning.checklist_summary %}
                                                        <div class="annual-planning-checklist">
                                                            {% if planning.checklist_summary.all_checked %}
                                                                <i class="fas fa-check-circle annual-checklist-icon all-checked"></i>
                                                            {% elif planning.checklist_summary.checked > 0 %}
                                                                <i class="fas fa-tasks annual-checklist-icon partial"></i>
                                                            {% else %}
                                                                <i class="fas fa-times-circle annual-checklist-icon none-checked"></i>
                                                            {% endif %}
                                                        </div>
                                                        {% endif %}
                                                        <span class="annual-planning-text">{{ planning.title }}</span>
                                                    </div>
                                                {% endfor %}
                                                {% if week.plannings[date_str]|length > 3 %}
                                                    <div class="annual-planning-more">+{{ week.plannings[date_str]|length - 3 }}</div>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <!-- Légende -->
            <div class="annual-legend">
                <div class="legend-item">
                    <div class="legend-box has-class"></div>
                    <span>Jour avec cours</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box"></div>
                    <span>Jour sans cours</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box today"></div>
                    <span>Aujourd'hui</span>
                </div>
                <div class="legend-item">
                    <i class="fas fa-check-circle" style="color: #10B981;"></i>
                    <span>Tâches complétées</span>
                </div>
                <div class="legend-item">
                    <i class="fas fa-tasks" style="color: #F59E0B;"></i>
                    <span>Tâches en cours</span>
                </div>
                <div class="legend-item">
                    <i class="fas fa-times-circle" style="color: #EF4444;"></i>
                    <span>Tâches non commencées</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Overlay pour les modals -->
<div class="modal-overlay" id="modalOverlay" style="display: none;"></div>

<!-- Modal de planification -->
<div class="planning-modal" id="planningModal">
    <div class="modal-content" id="planningModalContent">
        <div class="modal-header">
            <h3 id="modalTitle">Planifier le cours</h3>
            <div class="modal-header-actions">
                <button class="btn-icon" onclick="toggleSplitView()" title="Afficher/Masquer les fichiers">
                    <i class="fas fa-folder-open"></i>
                </button>
                <button class="modal-close" onclick="closePlanningModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Classe</label>
                <select id="modalClassroom" class="form-control">
                    <option value="">-- Sélectionner une classe --</option>
                    {% for classroom in classrooms %}
                    <option value="{{ classroom.id }}" data-color="{{ classroom.color }}">
                        {{ classroom.name }} - {{ classroom.subject }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Titre du cours</label>
                <input type="text" id="modalPlanningTitle" class="form-control"
                       placeholder="Ex: Introduction aux fractions">
            </div>

            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea id="modalDescription" class="form-control" rows="3"
                          placeholder="Détails du cours, exercices prévus..."></textarea>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closePlanningModal()">Annuler</button>
            <button class="btn btn-primary" onclick="savePlanning()">
                <i class="fas fa-save"></i> Enregistrer
            </button>
        </div>
    </div>

    <!-- Panneau gestionnaire de fichiers (caché par défaut) -->
    <div class="file-manager-panel" id="fileManagerPanel" style="display: none;">
        <div class="file-manager-header">
            <h3><i class="fas fa-folder-open"></i> Fichiers de la classe</h3>
            <button class="btn-icon" onclick="toggleSplitView()" title="Fermer">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="file-manager-content" id="fileManagerContent">
            <!-- Chargement initial -->
            <div class="file-loading" id="fileLoading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Chargement des fichiers...</p>
            </div>

            <!-- Navigation des dossiers -->
            <div class="file-navigation" id="fileNavigation" style="display: none;">
                <div class="breadcrumb" id="fileBreadcrumb">
                    <span class="breadcrumb-item active" data-path="" onclick="navigateToFileFolder('')">
                        <i class="fas fa-home"></i> Racine
                    </span>
                </div>
            </div>

            <!-- Arborescence des fichiers -->
            <div class="file-tree" id="fileTree" style="display: none;">
                <!-- L'arborescence sera chargée ici -->
            </div>

            <!-- État vide -->
            <div class="no-files" id="noFiles" style="display: none;">
                <i class="fas fa-folder-open"></i>
                <p>Aucun fichier dans cette classe</p>
            </div>
        </div>
    </div>

    <!-- Modal Viewer/Annotateur (même que lesson_view) -->
    <div class="file-viewer-modal" id="fileViewerModal">
        <div class="viewer-header">
            <div class="viewer-title">
            </div>
            <div class="viewer-tools">
                
                <!-- Outils de dessin -->
                <div class="tool-group">
                    <button class="tool-btn active" id="penTool" title="Stylo" data-tool="pen">
                        <i class="fas fa-pen"></i>
                    </button>
                    <button class="tool-btn" id="highlighterTool" title="Surligneur" data-tool="highlighter">
                        <i class="fas fa-highlighter"></i>
                    </button>
                    <button class="tool-btn" id="eraserTool" title="Gomme" data-tool="eraser">
                        <i class="fas fa-eraser"></i>
                    </button>
                </div>
                
                <!-- Couleurs -->
                <div class="color-picker-container">
                    <div class="preset-colors">
                        <button class="color-btn active" data-color="#000000" style="background-color: #000000" title="Noir"></button>
                        <button class="color-btn" data-color="#EF4444" style="background-color: #EF4444" title="Rouge"></button>
                        <button class="color-btn" data-color="#F59E0B" style="background-color: #F59E0B" title="Orange"></button>
                        <button class="color-btn" data-color="#EAB308" style="background-color: #EAB308" title="Jaune"></button>
                        <button class="color-btn" data-color="#22C55E" style="background-color: #22C55E" title="Vert"></button>
                        <button class="color-btn" data-color="#3B82F6" style="background-color: #3B82F6" title="Bleu"></button>
                    </div>
                    <input type="color" id="annotationColor" value="#000000" title="Couleur personnalisée">
                </div>
                
                <div class="stroke-width-container">
                    <input type="range" id="strokeWidth" min="1" max="20" value="3" title="Épaisseur">
                    <span id="strokeWidthValue">3</span>
                </div>
                
                <!-- Actions -->
                <div class="tool-group">
                    <button class="tool-btn" id="saveBtn" title="Sauvegarder maintenant" onclick="saveAnnotations()">
                        <i class="fas fa-save"></i>
                    </button>
                    <button class="tool-btn" id="undoBtn" title="Annuler">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button class="tool-btn" id="clearAllBtn" title="Tout effacer">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <button class="close-viewer" onclick="closeFileViewer()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="viewer-content">
            <!-- Barre latérale des pages - permanente à gauche -->
            <div class="page-sidebar show" id="pageSidebar">
                <div class="sidebar-header">
                    <h6><i class="fas fa-copy"></i> Pages</h6>
                </div>
                <div class="page-thumbnails scrollable" id="pageThumbnails">
                    <!-- Les miniatures seront générées ici -->
                </div>
            </div>
            
            <!-- Zone d'affichage principal -->
            <div class="viewer-container" id="viewerContainer">
                <div class="pdf-pages-container" id="pdfPagesContainer">
                    <!-- Les pages PDF seront ajoutées ici dynamiquement -->
                </div>
            </div>
        </div>
        <div class="viewer-footer">
            <div class="save-status" id="saveStatus">
                <i class="fas fa-info-circle"></i> Sauvegarde à la fermeture
            </div>
        </div>
    </div>
</div>

<form id="weekNavigationForm" method="GET" style="display: none;">
    <input type="hidden" name="week" id="weekInput">
    <input type="hidden" name="classroom" value="{{ selected_classroom_id }}">
</form>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/planning.js') }}"></script>
<script>
const currentWeek = '{{ current_week.strftime("%Y-%m-%d") }}';
const selectedClassroomId = {{ selected_classroom_id or 'null' }};
const periodsData = {{ periods_json | tojson }};
const classrooms = {{ classrooms_json | tojson }};
let currentPlanningCell = null;
let isExtendedView = false;

// Gérer le clic sur une case de la vue annuelle
function handleAnnualDayClick(element, dateStr) {
    if (element.dataset.hasClass !== 'true' || element.classList.contains('single-day-holiday')) return;

    // Récupérer l'ID de la classe actuellement sélectionnée dans la vue annuelle
    const classroomId = selectedClassroomId;

    // Ouvrir le modal de planification journalière avec filtrage par classe
    openDayPlanningModal(dateStr, classroomId);
}

function navigateToWeek(weekStartDate) {
    // Ajouter un effet visuel de chargement sur la vue hebdomadaire uniquement
    const weeklyView = document.querySelector('.weekly-view');
    weeklyView.classList.add('loading');

    // Utiliser le formulaire existant avec la date de début de semaine
    document.getElementById('weekInput').value = weekStartDate;

    // Soumettre le formulaire
    document.getElementById('weekNavigationForm').submit();
}

function navigateWeek(direction) {
    // Ajouter un effet de chargement sur la vue hebdomadaire
    const weeklyView = document.querySelector('.weekly-view');
    weeklyView.classList.add('loading');

    const currentDate = new Date('{{ current_week }}');
    if (direction === 'prev') {
        currentDate.setDate(currentDate.getDate() - 7);
    } else {
        currentDate.setDate(currentDate.getDate() + 7);
    }

    document.getElementById('weekInput').value = formatDate(currentDate);
    document.getElementById('weekNavigationForm').submit();
}

function navigateToToday() {
    // Ajouter un effet de chargement sur la vue hebdomadaire
    const weeklyView = document.querySelector('.weekly-view');
    weeklyView.classList.add('loading');

    const today = new Date();
    document.getElementById('weekInput').value = formatDate(today);
    document.getElementById('weekNavigationForm').submit();
}

function selectClassroom(classroomId) {
    const url = new URL(window.location);
    url.searchParams.set('classroom', classroomId);
    window.location = url;
}

function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Basculer entre vue normale et vue étendue
function toggleViewMode() {
    const calendarMain = document.querySelector('.calendar-main');
    const toggleIcon = document.getElementById('toggleIcon');
    const toggleText = document.getElementById('toggleText');

    isExtendedView = !isExtendedView;

    if (isExtendedView) {
        calendarMain.classList.add('extended-view');
        toggleIcon.className = 'fas fa-compress-alt';
        toggleText.textContent = 'Vue normale';
    } else {
        calendarMain.classList.remove('extended-view');
        toggleIcon.className = 'fas fa-expand-alt';
        toggleText.textContent = 'Vue étendue';
    }

    // Sauvegarder la préférence
    localStorage.setItem('calendarViewMode', isExtendedView ? 'extended' : 'normal');
}

// Appliquer la couleur de la classe sélectionnée
function applyClassroomColor() {
    const selectedClassroom = {{ classrooms_json | tojson }}.find(c => c.id === selectedClassroomId);
    if (selectedClassroom && selectedClassroom.color) {
        const annualGrid = document.querySelector('.annual-grid');
        if (annualGrid) {
            // Appliquer la couleur comme variable CSS
            annualGrid.style.setProperty('--classroom-color', selectedClassroom.color);
        }
    }
}

// Initialiser les données de planification au chargement
document.addEventListener('DOMContentLoaded', function() {
    loadWeeklyPlannings();
    applyClassroomColor();

    // Restaurer la préférence de vue
    const savedViewMode = localStorage.getItem('calendarViewMode');
    if (savedViewMode === 'extended' && !isExtendedView) {
        toggleViewMode();
    }
});

<!-- Ajoutez ce script dans calendar_view.html après le script existant dans le bloc extra_js -->


// Ajout des styles CSS inline pour les éléments de période passée
const styleSheet = document.createElement('style');
styleSheet.textContent = `
    .past-period-description {
        background-color: #F9FAFB;
        border: 1px solid #E5E7EB;
        border-radius: 0.375rem;
        padding: 1rem;
        min-height: 60px;
        line-height: 1.5;
    }

    .checklist-item {
        display: flex;
        align-items: center;
        margin: 0.5rem 0;
        padding: 0.25rem 0;
    }

    .checklist-item.completed {
        color: #10B981;
    }

    .checklist-item.completed span {
        text-decoration: line-through;
    }

    .checklist-item.not-completed {
        color: #EF4444;
    }

    .checklist-item i {
        margin-right: 0.5rem;
        font-size: 1rem;
    }

    .modal-body .form-control:disabled {
        background-color: #F3F4F6;
        cursor: not-allowed;
    }

    .checklist-help {
        font-size: 0.75rem;
        color: var(--gray-color);
        margin-top: 0.5rem;
        font-style: italic;
    }
`;
document.head.appendChild(styleSheet);

// S'assurer que la notification est disponible
if (typeof showNotification === 'undefined') {
    window.showNotification = function(type, message) {
        // Créer le conteneur de notifications s'il n'existe pas
        let container = document.querySelector('.notifications-container');
        if (!container) {
            container = document.createElement('div');
            container.className = 'notifications-container';
            container.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 1000;';
            document.body.appendChild(container);
        }

        // Créer la notification
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.style.cssText = `
            background-color: ${type === 'success' ? '#D1FAE5' : '#FEE2E2'};
            color: ${type === 'success' ? '#065F46' : '#991B1B'};
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: slideInNotification 0.3s ease;
            max-width: 400px;
        `;

        const icon = document.createElement('i');
        icon.className = `fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}`;

        const text = document.createElement('span');
        text.textContent = message;

        notification.appendChild(icon);
        notification.appendChild(text);
        container.appendChild(notification);

        // Supprimer la notification après 5 secondes
        setTimeout(() => {
            notification.style.animation = 'slideOutNotification 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    };
}

// Variables pour le gestionnaire de fichiers
let currentFilePath = '';
let isSplitViewOpen = false;

// Variables pour le lecteur PDF avec annotations
let currentFileId = null;
let currentPageNum = 1;
let currentScale = 1.0;
let pdfDocument = null;

// Variables pour les annotations
let annotations = [];
let isDrawing = false;
let lastPoint = null;
let currentTool = 'pen';
let currentColor = '#000000';
let currentLineWidth = 3;

// Canvas pour les annotations
let annotationCanvas = null;
let annotationCtx = null;
let pdfCanvas = null;
let pdfCtx = null;

// Basculer l'affichage du gestionnaire de fichiers
function toggleSplitView() {
    const modal = document.getElementById('planningModal');
    const fileManagerPanel = document.getElementById('fileManagerPanel');
    
    isSplitViewOpen = !isSplitViewOpen;
    
    if (isSplitViewOpen) {
        modal.classList.add('split-view');
        fileManagerPanel.style.display = 'flex';
        
        // Charger les fichiers de la classe sélectionnée
        const classroomId = document.getElementById('modalClassroom').value;
        if (classroomId) {
            loadClassFiles(classroomId);
        } else {
            // Si aucune classe n'est sélectionnée, afficher un message
            document.getElementById('fileLoading').style.display = 'none';
            document.getElementById('fileNavigation').style.display = 'none';
            document.getElementById('fileTree').style.display = 'none';
            document.getElementById('noFiles').style.display = 'block';
            document.getElementById('noFiles').innerHTML = `
                <i class="fas fa-exclamation-circle"></i>
                <p>Veuillez sélectionner une classe</p>
            `;
        }
    } else {
        modal.classList.remove('split-view');
        fileManagerPanel.style.display = 'none';
    }
}

// Charger les fichiers d'une classe
async function loadClassFiles(classroomId) {
    const fileLoading = document.getElementById('fileLoading');
    const fileNavigation = document.getElementById('fileNavigation');
    const fileTree = document.getElementById('fileTree');
    const noFiles = document.getElementById('noFiles');
    
    console.log('Chargement des fichiers pour la classe:', classroomId);
    
    // Afficher le chargement
    fileLoading.style.display = 'block';
    fileNavigation.style.display = 'none';
    fileTree.style.display = 'none';
    noFiles.style.display = 'none';
    
    try {
        const response = await fetch(`/api/class-files/${classroomId}`);
        console.log('Réponse API:', response);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Données reçues:', data);
        
        fileLoading.style.display = 'none';
        
        if (data.success && data.files && data.files.length > 0) {
            // Stocker tous les fichiers globalement
            allClassFiles = data.files;
            fileNavigation.style.display = 'block';
            fileTree.style.display = 'block';
            renderFileTree(data.files, currentFilePath);
        } else {
            console.log('Aucun fichier trouvé ou erreur dans la réponse');
            noFiles.style.display = 'block';
        }
    } catch (error) {
        console.error('Erreur lors du chargement des fichiers:', error);
        fileLoading.style.display = 'none';
        noFiles.style.display = 'block';
    }
}

// Afficher l'arborescence des fichiers
function renderFileTree(files, currentPath = '') {
    const fileTree = document.getElementById('fileTree');
    fileTree.innerHTML = '';
    
    // Organiser les fichiers par dossier
    const folders = {};
    const currentLevelFiles = [];
    const allFolders = new Set();
    
    files.forEach(file => {
        if (file.folder_path) {
            // Extraire tous les dossiers du chemin
            const pathParts = file.folder_path.split('/').filter(p => p);
            let accumulatedPath = '';
            
            pathParts.forEach((part, index) => {
                const parentPath = accumulatedPath;
                accumulatedPath = accumulatedPath ? `${accumulatedPath}/${part}` : part;
                
                allFolders.add(accumulatedPath);
                
                if (!folders[accumulatedPath]) {
                    folders[accumulatedPath] = {
                        name: part,
                        path: accumulatedPath,
                        parent: parentPath,
                        files: [],
                        subfolders: new Set()
                    };
                }
                
                // Ajouter le sous-dossier au parent
                if (parentPath && folders[parentPath]) {
                    folders[parentPath].subfolders.add(accumulatedPath);
                }
                
                // Ajouter le fichier au dernier dossier
                if (index === pathParts.length - 1) {
                    folders[accumulatedPath].files.push(file);
                }
            });
            
            // Si on navigue dans un dossier spécifique
            if (currentPath && file.folder_path.startsWith(currentPath)) {
                const relativePath = file.folder_path.substring(currentPath.length).replace(/^\//, '');
                const relativePathParts = relativePath.split('/').filter(p => p);
                
                // Si le fichier est directement dans le dossier courant
                if (relativePathParts.length === 0 || (relativePathParts.length === 1 && relativePathParts[0] === '')) {
                    currentLevelFiles.push(file);
                }
            }
        } else if (!currentPath) {
            // Fichiers à la racine seulement si on est à la racine
            currentLevelFiles.push(file);
        }
    });
    
    // Si on navigue dans un dossier, ajouter un bouton retour
    if (currentPath) {
        const backItem = document.createElement('div');
        backItem.className = 'file-item';
        backItem.innerHTML = `
            <i class="fas fa-arrow-left file-icon"></i>
            <span class="file-name">..</span>
        `;
        backItem.onclick = () => {
            const parentPath = currentPath.includes('/') ? 
                currentPath.substring(0, currentPath.lastIndexOf('/')) : '';
            navigateToFolder(parentPath);
        };
        fileTree.appendChild(backItem);
    }
    
    // Afficher les dossiers du niveau actuel
    Object.values(folders).forEach(folder => {
        const shouldShow = currentPath ? 
            folder.parent === currentPath : 
            !folder.parent;
        
        if (shouldShow) {
            const folderItem = document.createElement('div');
            folderItem.className = 'file-item folder';
            folderItem.innerHTML = `
                <i class="fas fa-folder file-icon"></i>
                <span class="file-name">${folder.name}</span>
            `;
            folderItem.onclick = () => navigateToFolder(folder.path);
            fileTree.appendChild(folderItem);
        }
    });
    
    // Afficher les fichiers du niveau actuel
    currentLevelFiles.forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        
        const icon = getFileIconByType(file.file_type);
        
        fileItem.innerHTML = `
            <i class="${icon} file-icon"></i>
            <span class="file-name">${file.original_filename}</span>
        `;
        
        if (file.file_type === 'pdf') {
            fileItem.onclick = () => openPdfInViewer(file.id, file.original_filename);
        }
        
        fileTree.appendChild(fileItem);
    });
    
    // Mettre à jour le fil d'Ariane
    updateBreadcrumb(currentPath);
}

// Variable globale pour stocker tous les fichiers
let allClassFiles = [];

// Obtenir l'icône appropriée pour un type de fichier
function getFileIconByType(fileType) {
    switch (fileType) {
        case 'pdf':
            return 'fas fa-file-pdf';
        case 'jpg':
        case 'jpeg':
        case 'png':
        case 'gif':
            return 'fas fa-file-image';
        default:
            return 'fas fa-file';
    }
}

// Naviguer dans un dossier
function navigateToFolder(folderPath) {
    currentFilePath = folderPath;
    console.log('Navigation vers le dossier:', folderPath);
    
    // Re-render l'arbre avec le nouveau chemin
    renderFileTree(allClassFiles, folderPath);
}

// Mettre à jour le fil d'Ariane
function updateBreadcrumb(path) {
    const breadcrumb = document.getElementById('fileBreadcrumb');
    breadcrumb.innerHTML = '';
    
    // Racine
    const rootItem = document.createElement('span');
    rootItem.className = 'breadcrumb-item';
    rootItem.innerHTML = '<i class="fas fa-home"></i> Racine';
    rootItem.onclick = () => navigateToFolder('');
    breadcrumb.appendChild(rootItem);
    
    // Ajouter les parties du chemin
    if (path) {
        const parts = path.split('/').filter(p => p);
        let accumulatedPath = '';
        
        parts.forEach((part, index) => {
            // Ajouter le séparateur
            const separator = document.createElement('i');
            separator.className = 'fas fa-chevron-right';
            separator.style.cssText = 'margin: 0 0.5rem; font-size: 0.75rem; color: #9ca3af;';
            breadcrumb.appendChild(separator);
            
            // Construire le chemin accumulé
            accumulatedPath = accumulatedPath ? `${accumulatedPath}/${part}` : part;
            
            // Créer l'élément du fil d'Ariane
            const partItem = document.createElement('span');
            partItem.className = index === parts.length - 1 ? 'breadcrumb-item active' : 'breadcrumb-item';
            partItem.textContent = part;
            
            if (index < parts.length - 1) {
                const pathToNavigate = accumulatedPath;
                partItem.onclick = () => navigateToFolder(pathToNavigate);
            }
            
            breadcrumb.appendChild(partItem);
        });
    }
}


// Ouvrir un PDF dans le lecteur intégré (même interface que lesson_view)
function openPdfInViewer(fileId, fileName) {
    console.log('Ouverture du PDF:', fileName);
    openFileViewer(fileId, fileName, 'pdf');
}

// Ouvrir le viewer de fichier en mode embedded pour calendar_view
async function openFileViewer(fileId, filename, fileType) {
    currentFileId = fileId;
    currentPageNum = 1;
    currentScale = 0.8; // Échelle réduite pour le mode split
    
    const modal = document.getElementById('fileViewerModal');
    modal.classList.add('show', 'embedded');
    
    // Initialiser les canvas et outils d'annotation
    initializeCanvases();
    
    // Mettre à jour le titre
    document.querySelector('.viewer-title').innerHTML = `<i class="fas fa-file-pdf"></i> ${filename}`;
    
    // Charger le PDF et les annotations
    if (fileType.toLowerCase() === 'pdf') {
        await loadPDF(fileId);
        await loadAnnotations(fileId);
        setupAnnotationTools();
        setupToolEvents();
    }
}

// Charger un PDF (version simplifiée)
async function loadPDF(fileId) {
    try {
        const url = `/api/class-files/preview/${fileId}`;
        console.log('📄 Chargement du PDF depuis:', url);
        
        const loadingTask = pdfjsLib.getDocument(url);
        pdfDocument = await loadingTask.promise;
        
        console.log(`📄 PDF chargé avec ${pdfDocument.numPages} pages`);
        
        // Effacer le conteneur
        const container = document.getElementById('pdfPagesContainer');
        container.innerHTML = '';
        
        // Effacer les miniatures
        const thumbnailContainer = document.getElementById('pageThumbnails');
        thumbnailContainer.innerHTML = '';
        
        // Créer les pages
        for (let pageIndex = 1; pageIndex <= pdfDocument.numPages; pageIndex++) {
            await createPDFPage(pageIndex);
        }
        
        console.log('📄 Toutes les pages créées avec succès');
        
    } catch (error) {
        console.error('❌ Erreur lors du chargement du PDF:', error);
    }
}

// Créer une page PDF avec canvas d'annotation
async function createPDFPage(pageIndex) {
    try {
        const page = await pdfDocument.getPage(pageIndex);
        const viewport = page.getViewport({ scale: currentScale });
        
        // Créer le conteneur de la page
        const pageContainer = document.createElement('div');
        pageContainer.className = 'pdf-page-container';
        pageContainer.style.cssText = `
            position: relative;
            margin-bottom: 1rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            background: white;
        `;
        
        // Créer le canvas pour le PDF
        const pdfCanvas = document.createElement('canvas');
        pdfCanvas.id = `pdf-canvas-${pageIndex}`;
        pdfCanvas.width = viewport.width;
        pdfCanvas.height = viewport.height;
        pdfCanvas.style.cssText = 'display: block; position: absolute; top: 0; left: 0;';
        
        // Créer le canvas pour les annotations
        const annotationCanvas = document.createElement('canvas');
        annotationCanvas.id = `annotation-canvas-${pageIndex}`;
        annotationCanvas.width = viewport.width;
        annotationCanvas.height = viewport.height;
        annotationCanvas.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
            display: block;
        `;
        
        // Ajouter les événements de dessin au canvas d'annotation
        setupDrawingEvents(annotationCanvas, pageIndex);
        
        pageContainer.appendChild(pdfCanvas);
        pageContainer.appendChild(annotationCanvas);
        
        // Ajouter au conteneur principal
        document.getElementById('pdfPagesContainer').appendChild(pageContainer);
        
        // Rendre la page PDF
        const ctx = pdfCanvas.getContext('2d');
        const renderContext = {
            canvasContext: ctx,
            viewport: viewport
        };
        
        await page.render(renderContext).promise;
        
        // Créer la miniature
        createThumbnail(page, pageIndex);
        
    } catch (error) {
        console.error(`❌ Erreur lors de la création de la page ${pageIndex}:`, error);
    }
}

// Créer une miniature
async function createThumbnail(page, pageIndex) {
    try {
        const thumbnailScale = 0.3;
        const viewport = page.getViewport({ scale: thumbnailScale });
        
        const thumbnailCanvas = document.createElement('canvas');
        thumbnailCanvas.width = viewport.width;
        thumbnailCanvas.height = viewport.height;
        thumbnailCanvas.style.cssText = `
            width: 100%;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            transition: border-color 0.2s;
        `;
        
        const ctx = thumbnailCanvas.getContext('2d');
        const renderContext = {
            canvasContext: ctx,
            viewport: viewport
        };
        
        await page.render(renderContext).promise;
        
        // Ajouter l'événement de clic
        thumbnailCanvas.onclick = () => scrollToPage(pageIndex);
        
        // Hover effect
        thumbnailCanvas.onmouseenter = () => {
            thumbnailCanvas.style.borderColor = '#4F46E5';
        };
        thumbnailCanvas.onmouseleave = () => {
            thumbnailCanvas.style.borderColor = 'transparent';
        };
        
        // Wrapper pour la miniature
        const thumbnailWrapper = document.createElement('div');
        thumbnailWrapper.style.cssText = `
            text-align: center;
            color: white;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
        `;
        
        const pageLabel = document.createElement('div');
        pageLabel.textContent = `Page ${pageIndex}`;
        pageLabel.style.marginBottom = '0.25rem';
        
        thumbnailWrapper.appendChild(pageLabel);
        thumbnailWrapper.appendChild(thumbnailCanvas);
        
        document.getElementById('pageThumbnails').appendChild(thumbnailWrapper);
        
    } catch (error) {
        console.error(`❌ Erreur lors de la création de la miniature ${pageIndex}:`, error);
    }
}

// Faire défiler vers une page
function scrollToPage(pageIndex) {
    const pageElement = document.getElementById(`pdf-canvas-${pageIndex}`);
    if (pageElement) {
        pageElement.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    }
}

// Fermer le lecteur de fichier
function closeFileViewer() {
    const modal = document.getElementById('fileViewerModal');
    modal.classList.remove('show');
    
    // Réinitialiser les variables
    currentFileId = null;
    currentPageNum = 1;
    currentScale = 1.0;
    pdfDocument = null;
}

// Initialiser les canvas d'annotation
function initializeCanvases() {
    // Cette fonction sera appelée après le chargement du PDF
    console.log('🎨 Initialisation des canvas d\'annotation...');
}

// Charger les annotations depuis le serveur
async function loadAnnotations(fileId) {
    try {
        const response = await fetch(`/file-manager/api/annotations/${fileId}`);
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.annotations) {
                annotations = data.annotations;
                console.log(`📝 ${annotations.length} annotations chargées`);
                // Redessiner les annotations après un délai pour s'assurer que les canvas sont prêts
                setTimeout(() => redrawAnnotations(), 500);
            }
        }
    } catch (error) {
        console.log('ℹ️ Aucune annotation existante ou erreur de chargement:', error);
        annotations = [];
    }
}

// Sauvegarder les annotations
async function saveAnnotations() {
    if (!currentFileId || annotations.length === 0) {
        console.log('💾 Aucune annotation à sauvegarder');
        return;
    }

    try {
        const response = await fetch('/file-manager/api/save-annotations', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                file_id: currentFileId,
                annotations: annotations
            })
        });

        if (response.ok) {
            console.log('💾 Annotations sauvegardées avec succès');
            updateSaveStatus('Sauvegardé', 'success');
        } else {
            throw new Error('Erreur de sauvegarde');
        }
    } catch (error) {
        console.error('❌ Erreur lors de la sauvegarde:', error);
        updateSaveStatus('Erreur de sauvegarde', 'error');
    }
}

// Configurer les outils d'annotation
function setupAnnotationTools() {
    console.log('🔧 Configuration des outils d\'annotation...');
    
    // Outils de dessin
    document.querySelectorAll('[data-tool]').forEach(btn => {
        btn.addEventListener('click', () => {
            currentTool = btn.dataset.tool;
            document.querySelectorAll('[data-tool]').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            console.log('🔧 Outil sélectionné:', currentTool);
        });
    });

    // Couleurs
    document.querySelectorAll('[data-color]').forEach(btn => {
        btn.addEventListener('click', () => {
            currentColor = btn.dataset.color;
            document.querySelectorAll('[data-color]').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            console.log('🎨 Couleur sélectionnée:', currentColor);
        });
    });

    // Couleur personnalisée
    const colorPicker = document.getElementById('annotationColor');
    if (colorPicker) {
        colorPicker.addEventListener('change', (e) => {
            currentColor = e.target.value;
            document.querySelectorAll('[data-color]').forEach(b => b.classList.remove('active'));
            console.log('🎨 Couleur personnalisée:', currentColor);
        });
    }

    // Épaisseur du trait
    const strokeWidth = document.getElementById('strokeWidth');
    const strokeWidthValue = document.getElementById('strokeWidthValue');
    if (strokeWidth && strokeWidthValue) {
        strokeWidth.addEventListener('input', (e) => {
            currentLineWidth = parseInt(e.target.value);
            strokeWidthValue.textContent = currentLineWidth;
            console.log('📏 Épaisseur:', currentLineWidth);
        });
    }
}

// Configurer les événements des outils
function setupToolEvents() {
    console.log('🔧 Configuration des événements d\'outils...');
    
    // Bouton d'annulation
    const undoBtn = document.getElementById('undoBtn');
    if (undoBtn) {
        undoBtn.addEventListener('click', undoLastAnnotation);
    }

    // Bouton de suppression
    const clearAllBtn = document.getElementById('clearAllBtn');
    if (clearAllBtn) {
        clearAllBtn.addEventListener('click', clearAllAnnotations);
    }
}

// Annuler la dernière annotation
function undoLastAnnotation() {
    if (annotations.length > 0) {
        annotations.pop();
        redrawAnnotations();
        console.log('↶ Annotation annulée');
    }
}

// Effacer toutes les annotations
function clearAllAnnotations() {
    if (confirm('Voulez-vous vraiment effacer toutes les annotations ?')) {
        annotations = [];
        redrawAnnotations();
        console.log('🗑️ Toutes les annotations effacées');
    }
}

// Redessiner toutes les annotations
function redrawAnnotations(force = false) {
    // Pour chaque page, redessiner ses annotations
    for (let pageIndex = 1; pageIndex <= (pdfDocument ? pdfDocument.numPages : 1); pageIndex++) {
        const annotationCanvas = document.getElementById(`annotation-canvas-${pageIndex}`);
        if (annotationCanvas) {
            const ctx = annotationCanvas.getContext('2d');
            ctx.clearRect(0, 0, annotationCanvas.width, annotationCanvas.height);
            
            // Dessiner les annotations de cette page
            const pageAnnotations = annotations.filter(ann => ann.page === pageIndex);
            pageAnnotations.forEach(annotation => {
                drawAnnotationOnCanvas(ctx, annotation);
            });
        }
    }
}

// Dessiner une annotation sur le canvas
function drawAnnotationOnCanvas(ctx, annotation) {
    if (!annotation.points || annotation.points.length === 0) return;

    ctx.globalCompositeOperation = annotation.tool === 'eraser' ? 'destination-out' : 'source-over';
    ctx.strokeStyle = annotation.color || '#000000';
    ctx.lineWidth = annotation.lineWidth || 3;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    if (annotation.tool === 'highlighter') {
        ctx.globalAlpha = 0.3;
    } else {
        ctx.globalAlpha = 1.0;
    }

    ctx.beginPath();
    ctx.moveTo(annotation.points[0].x, annotation.points[0].y);
    
    for (let i = 1; i < annotation.points.length; i++) {
        ctx.lineTo(annotation.points[i].x, annotation.points[i].y);
    }
    
    ctx.stroke();
    ctx.globalAlpha = 1.0;
    ctx.globalCompositeOperation = 'source-over';
}

// Mettre à jour le statut de sauvegarde
function updateSaveStatus(message, type = 'info') {
    const saveStatus = document.getElementById('saveStatus');
    if (saveStatus) {
        saveStatus.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i> ${message}`;
        
        if (type === 'success') {
            saveStatus.style.color = '#10B981';
            setTimeout(() => {
                saveStatus.innerHTML = '<i class="fas fa-info-circle"></i> Sauvegarde à la fermeture';
                saveStatus.style.color = '';
            }, 3000);
        }
    }
}

// Configurer les événements de dessin pour un canvas d'annotation
function setupDrawingEvents(canvas, pageIndex) {
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let currentStroke = [];
    
    // Fonction pour obtenir les coordonnées relatives au canvas
    function getCanvasCoordinates(e, canvas) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        let clientX, clientY;
        
        if (e.touches && e.touches.length > 0) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }
        
        return {
            x: (clientX - rect.left) * scaleX,
            y: (clientY - rect.top) * scaleY
        };
    }
    
    // Fonction pour dessiner un point
    function drawPoint(ctx, x, y) {
        ctx.globalCompositeOperation = currentTool === 'eraser' ? 'destination-out' : 'source-over';
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = currentLineWidth;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        if (currentTool === 'highlighter') {
            ctx.globalAlpha = 0.3;
        } else {
            ctx.globalAlpha = 1.0;
        }
        
        ctx.beginPath();
        ctx.arc(x, y, currentLineWidth / 2, 0, 2 * Math.PI);
        ctx.fill();
        
        ctx.globalAlpha = 1.0;
        ctx.globalCompositeOperation = 'source-over';
    }
    
    // Fonction pour dessiner une ligne
    function drawLine(ctx, x1, y1, x2, y2) {
        ctx.globalCompositeOperation = currentTool === 'eraser' ? 'destination-out' : 'source-over';
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = currentLineWidth;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        if (currentTool === 'highlighter') {
            ctx.globalAlpha = 0.3;
        } else {
            ctx.globalAlpha = 1.0;
        }
        
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
        
        ctx.globalAlpha = 1.0;
        ctx.globalCompositeOperation = 'source-over';
    }
    
    // Début du dessin (mousedown, touchstart)
    function startDrawing(e) {
        e.preventDefault();
        isDrawing = true;
        
        const coords = getCanvasCoordinates(e, canvas);
        currentStroke = [{
            x: coords.x,
            y: coords.y
        }];
        
        // Dessiner le premier point
        drawPoint(ctx, coords.x, coords.y);
        
        console.log(`🎨 Début du dessin sur page ${pageIndex} à (${coords.x}, ${coords.y})`);
    }
    
    // Continuation du dessin (mousemove, touchmove)
    function continueDrawing(e) {
        if (!isDrawing) return;
        
        e.preventDefault();
        const coords = getCanvasCoordinates(e, canvas);
        
        // Ajouter le point au trait courant
        currentStroke.push({
            x: coords.x,
            y: coords.y
        });
        
        // Dessiner la ligne depuis le point précédent
        if (currentStroke.length > 1) {
            const prevPoint = currentStroke[currentStroke.length - 2];
            drawLine(ctx, prevPoint.x, prevPoint.y, coords.x, coords.y);
        }
    }
    
    // Fin du dessin (mouseup, touchend)
    function stopDrawing(e) {
        if (!isDrawing) return;
        
        e.preventDefault();
        isDrawing = false;
        
        // Sauvegarder l'annotation
        if (currentStroke.length > 0) {
            const annotation = {
                page: pageIndex,
                tool: currentTool,
                color: currentColor,
                lineWidth: currentLineWidth,
                points: [...currentStroke]
            };
            
            annotations.push(annotation);
            console.log(`💾 Annotation sauvegardée sur page ${pageIndex}:`, annotation);
            
            // Indiquer que des modifications ont été apportées
            updateSaveStatus('Modifications non sauvegardées', 'info');
        }
        
        currentStroke = [];
    }
    
    // Événements de souris
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', continueDrawing);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseleave', stopDrawing);
    
    // Événements tactiles pour les appareils mobiles
    canvas.addEventListener('touchstart', startDrawing);
    canvas.addEventListener('touchmove', continueDrawing);
    canvas.addEventListener('touchend', stopDrawing);
    canvas.addEventListener('touchcancel', stopDrawing);
    
    // Empêcher le défilement de la page lors du dessin tactile
    canvas.addEventListener('touchstart', (e) => e.preventDefault());
    canvas.addEventListener('touchmove', (e) => e.preventDefault());
    
    console.log(`🔧 Événements de dessin configurés pour page ${pageIndex}`);
}

// Écouter les changements de classe sélectionnée
document.addEventListener('DOMContentLoaded', function() {
    const classroomSelect = document.getElementById('modalClassroom');
    if (classroomSelect) {
        classroomSelect.addEventListener('change', function() {
            if (isSplitViewOpen && this.value) {
                loadClassFiles(this.value);
            }
        });
    }
});

// Modifier la fonction closePlanningModal pour réinitialiser l'état
const originalClosePlanningModal = window.closePlanningModal || function() {};
window.closePlanningModal = function() {
    // Fermer le split view si ouvert
    if (isSplitViewOpen) {
        toggleSplitView();
    }
    
    // Masquer l'overlay
    document.getElementById('modalOverlay').style.display = 'none';
    
    // Réinitialiser le contenu du gestionnaire de fichiers
    document.getElementById('noFiles').innerHTML = `
        <i class="fas fa-folder-open"></i>
        <p>Aucun fichier dans cette classe</p>
    `;
    
    // Fermer le lecteur PDF s'il est ouvert
    const fileViewerModal = document.getElementById('fileViewerModal');
    if (fileViewerModal.classList.contains('show')) {
        closeFileViewer();
    }
    
    // Appeler la fonction originale
    if (typeof originalClosePlanningModal === 'function') {
        originalClosePlanningModal();
    } else {
        document.getElementById('planningModal').classList.remove('show');
    }
};

// Surcharger la fonction openPlanningModal pour afficher l'overlay
document.addEventListener('DOMContentLoaded', function() {
    // Attendre un peu pour que planning.js soit chargé
    setTimeout(function() {
        const originalOpenPlanningModal = window.openPlanningModal;
        if (typeof originalOpenPlanningModal === 'function') {
            window.openPlanningModal = function(cell, fromAnnualView) {
                // Afficher l'overlay
                const overlay = document.getElementById('modalOverlay');
                if (overlay) {
                    overlay.style.display = 'block';
                }
                
                // Appeler la fonction originale
                originalOpenPlanningModal(cell, fromAnnualView);
            };
        }
    }, 100);
});

// Fermer le modal en cliquant sur l'overlay
document.addEventListener('DOMContentLoaded', function() {
    const overlay = document.getElementById('modalOverlay');
    if (overlay) {
        overlay.addEventListener('click', function() {
            closePlanningModal();
        });
    }
});

</script>
{% endblock %}
