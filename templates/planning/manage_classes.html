{% extends "base.html" %}

{% block title %}Gestion des classes - TeacherPlanner{% endblock %}

{% block extra_css %}
<style>
.manage-classes-container {
    max-width: 1400px;
    margin: 0 auto;
}

.classes-header {
    background-color: var(--white);
    padding: 1.5rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    margin-bottom: 2rem;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.header-title {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.header-title h1 {
    margin: 0;
    font-size: 1.75rem;
}

.class-selector {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.class-selector select {
    padding: 0.5rem 1rem;
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius);
    font-size: 1rem;
    background-color: var(--white);
}

/* Tabs */
.tabs-container {
    border-bottom: 2px solid var(--light-gray);
    margin-bottom: 2rem;
}

.tabs {
    display: flex;
    gap: 0;
}

.tab-button {
    padding: 1rem 2rem;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    color: var(--gray-color);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.tab-button:hover {
    color: var(--primary-color);
}

.tab-button.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
}

.tab-content {
    display: none;
    animation: fadeIn 0.3s ease;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Students section */
.students-section {
    background-color: var(--white);
    padding: 2rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.students-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.student-card {
    background-color: var(--light-gray);
    padding: 1rem;
    border-radius: var(--border-radius);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s ease;
}

.student-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}

.student-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.student-avatar {
    width: 40px;
    height: 40px;
    background-color: var(--primary-color);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
}

.student-details h4 {
    margin: 0;
    font-size: 1rem;
}

.student-details p {
    margin: 0;
    font-size: 0.875rem;
    color: var(--gray-color);
}

.student-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-icon {
    width: 36px;
    height: 36px;
    border: none;
    background-color: transparent;
    color: var(--gray-color);
    border-radius: var(--border-radius);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.btn-icon:hover {
    background-color: var(--light-gray);
    color: var(--primary-color);
}

.btn-icon.danger:hover {
    background-color: #FEE2E2;
    color: var(--danger-color);
}

/* Add student form */
.add-student-form {
    background-color: #F9FAFB;
    padding: 1.5rem;
    border-radius: var(--border-radius);
    border: 2px dashed var(--primary-color);
    margin-bottom: 2rem;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

/* Grades section */
.grades-section {
    background-color: var(--white);
    padding: 2rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
}

.grades-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-box {
    background-color: var(--light-gray);
    padding: 1.5rem;
    border-radius: var(--border-radius);
    text-align: center;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
}

.stat-label {
    font-size: 0.875rem;
    color: var(--gray-color);
}

.grades-table {
    width: 100%;
    background-color: var(--white);
    border-radius: var(--border-radius);
    overflow: hidden;
}

.grades-table table {
    width: 100%;
    border-collapse: collapse;
}

.grades-table th {
    background-color: var(--light-gray);
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--dark-color);
}

.grades-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--light-gray);
}

.grades-table tr:hover {
    background-color: #F9FAFB;
}

.grade-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 600;
}

.grade-badge.excellent {
    background-color: #D1FAE5;
    color: #065F46;
}

.grade-badge.good {
    background-color: #DBEAFE;
    color: #1E40AF;
}

.grade-badge.average {
    background-color: #FEF3C7;
    color: #92400E;
}

.grade-badge.poor {
    background-color: #FEE2E2;
    color: #991B1B;
}

/* Files section */
.files-section {
    background-color: var(--white);
    padding: 2rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
}

.upload-zone {
    border: 2px dashed var(--primary-color);
    border-radius: var(--border-radius);
    padding: 3rem;
    text-align: center;
    background-color: #F9FAFB;
    margin-bottom: 2rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.upload-zone:hover {
    background-color: #EFF6FF;
    border-color: var(--primary-hover);
}

.upload-zone i {
    font-size: 3rem;
    color: var(--primary-color);
    margin-bottom: 1rem;
}

.files-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
}

.file-card {
    background-color: var(--light-gray);
    padding: 1rem;
    border-radius: var(--border-radius);
    text-align: center;
    transition: all 0.2s ease;
    cursor: pointer;
}

.file-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}

.file-icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.file-icon.pdf { color: #DC2626; }
.file-icon.doc { color: #2563EB; }
.file-icon.img { color: #059669; }
.file-icon.other { color: #6B7280; }

.file-name {
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 0.25rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.file-size {
    font-size: 0.75rem;
    color: var(--gray-color);
}

/* Sanctions section */
.sanctions-section {
    background-color: var(--white);
    padding: 2rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
}

.sanctions-table-container {
    overflow-x: auto;
    border-radius: var(--border-radius);
    border: 1px solid var(--light-gray);
}

.sanctions-table {
    width: 100%;
    border-collapse: collapse;
    background-color: var(--white);
    min-width: 600px;
}

.sanctions-table th {
    background-color: var(--light-gray);
    padding: 1rem;
    text-align: center;
    font-weight: 600;
    color: var(--dark-color);
    border-bottom: 2px solid var(--primary-color);
    position: sticky;
    top: 0;
    z-index: 1;
}

.sanctions-table th.student-column {
    text-align: left;
    min-width: 200px;
    max-width: 200px;
}

.sanctions-table th.sanction-column {
    min-width: 120px;
    font-size: 0.875rem;
}

.sanctions-table td {
    padding: 0.75rem;
    border-bottom: 1px solid var(--light-gray);
    vertical-align: middle;
}

.sanctions-table tr:hover {
    background-color: #F9FAFB;
}

.student-name {
    font-weight: 500;
    color: var(--dark-color);
    text-align: left;
}

.sanction-count {
    text-align: center;
}

.count-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.count-btn {
    width: 28px;
    height: 28px;
    border: 1px solid var(--light-gray);
    background-color: var(--white);
    color: var(--gray-color);
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    transition: all 0.2s ease;
}

.count-btn:hover {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
    transform: scale(1.1);
}

.count-btn.decrease:hover {
    background-color: var(--danger-color);
    border-color: var(--danger-color);
}

.count-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.count-display {
    font-weight: 600;
    font-size: 1.125rem;
    min-width: 30px;
    text-align: center;
    color: var(--dark-color);
    padding: 0.25rem 0.5rem;
    border-radius: var(--border-radius);
    background-color: var(--light-gray);
}

.count-display.warning {
    background-color: #FEF3C7;
    color: #92400E;
}

.count-display.danger {
    background-color: #FEE2E2;
    color: #991B1B;
}

/* Empty states */
.empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--gray-color);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state p {
    margin-bottom: 1rem;
}

/* Responsive */
@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        gap: 1rem;
    }

    .tabs {
        overflow-x: auto;
    }

    .tab-button {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="manage-classes-container">
    <!-- En-tête -->
    <div class="classes-header">
        <div class="header-content">
            <div class="header-title">
                <h1><i class="fas fa-users"></i> Gestion des classes</h1>
            </div>
            <div class="class-selector">
                <label for="classSelect">Classe :</label>
                <select id="classSelect" onchange="changeClass(this.value)">
                    {% for classroom in classrooms %}
                    <option value="{{ classroom.id }}" {% if classroom.id == selected_classroom_id %}selected{% endif %}>
                        {{ classroom.name }} - {{ classroom.subject }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab-button active" onclick="showTab('students')">
                    <i class="fas fa-user-graduate"></i> Élèves
                </button>
                <button class="tab-button" onclick="showTab('grades')">
                    <i class="fas fa-clipboard-check"></i> Notes
                </button>
                <button class="tab-button" onclick="showTab('files')">
                    <i class="fas fa-folder-open"></i> Fichiers
                </button>
                <button class="tab-button" onclick="showTab('sanctions')">
                    <i class="fas fa-exclamation-triangle"></i> Sanctions
                </button>
            </div>
        </div>
    </div>

    <!-- Contenu des onglets -->
    <!-- Onglet Élèves -->
    <div id="students-tab" class="tab-content active">
        <div class="students-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-user-graduate"></i> Liste des élèves
                </h2>
                <button class="btn btn-primary" onclick="toggleAddStudentForm()">
                    <i class="fas fa-plus"></i> Ajouter un élève
                </button>
            </div>

            <!-- Formulaire d'ajout d'élève (caché par défaut) -->
            <div id="addStudentForm" class="add-student-form" style="display: none;">
                <h3>Nouvel élève</h3>
                <form id="studentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Prénom <span style="color: var(--danger-color);">*</span></label>
                            <input type="text" class="form-control" id="studentFirstName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nom de famille</label>
                            <input type="text" class="form-control" id="studentLastName">
                            <small style="color: var(--gray-color); font-size: 0.75rem;">Obligatoire uniquement si un élève a déjà ce prénom</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email (optionnel)</label>
                            <input type="email" class="form-control" id="studentEmail">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                        <button type="button" class="btn btn-outline" onclick="toggleAddStudentForm()">
                            Annuler
                        </button>
                    </div>
                </form>
            </div>

            <!-- Liste des élèves -->
            {% if students %}
            <div class="students-grid">
                {% for student in students %}
                <div class="student-card" id="student-{{ student.id }}">
                    <div class="student-info">
                        <div class="student-avatar">
                            {{ student.first_name[0] }}{{ student.last_name[0] if student.last_name else '' }}
                        </div>
                        <div class="student-details">
                            <h4>{{ student.full_name }}</h4>
                            {% if student.email %}
                            <p>{{ student.email }}</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="student-actions">
                        <button class="btn-icon" title="Modifier" onclick="editStudent({{ student.id }})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon danger" title="Supprimer" onclick="deleteStudent({{ student.id }}, '{{ student.full_name }}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-user-graduate"></i>
                <p>Aucun élève dans cette classe</p>
                <button class="btn btn-primary" onclick="toggleAddStudentForm()">
                    <i class="fas fa-plus"></i> Ajouter le premier élève
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Onglet Notes -->
    <div id="grades-tab" class="tab-content">
        <div class="grades-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-clipboard-check"></i> Gestion des notes
                </h2>
                <button class="btn btn-primary">
                    <i class="fas fa-plus"></i> Nouvelle évaluation
                </button>
            </div>

            <!-- Statistiques -->
            <div class="grades-stats">
                <div class="stat-box">
                    <div class="stat-value">{{ students|length }}</div>
                    <div class="stat-label">Élèves</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">{{ recent_grades|length }}</div>
                    <div class="stat-label">Évaluations</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">-</div>
                    <div class="stat-label">Moyenne classe</div>
                </div>
            </div>

            <!-- Tableau des notes récentes -->
            {% if recent_grades %}
            <div class="grades-table">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Évaluation</th>
                            <th>Élève</th>
                            <th>Note</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for grade in recent_grades %}
                        <tr>
                            <td>{{ grade.date.strftime('%d/%m/%Y') }}</td>
                            <td>{{ grade.title }}</td>
                            <td>{{ grade.student.full_name }}</td>
                            <td>
                                <span class="grade-badge {% if grade.percentage >= 80 %}excellent{% elif grade.percentage >= 60 %}good{% elif grade.percentage >= 40 %}average{% else %}poor{% endif %}">
                                    {{ grade.grade }}/{{ grade.max_grade }}
                                </span>
                            </td>
                            <td>
                                <button class="btn-icon" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-clipboard-check"></i>
                <p>Aucune note enregistrée</p>
                <button class="btn btn-primary">
                    <i class="fas fa-plus"></i> Créer une première évaluation
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Onglet Fichiers -->
    <div id="files-tab" class="tab-content">
        <div class="files-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-folder-open"></i> Fichiers de la classe
                </h2>
            </div>

            <!-- Zone d'upload -->
            <div class="upload-zone" onclick="alert('Fonctionnalité d\'upload à venir')">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Glissez vos fichiers ici ou cliquez pour parcourir</p>
                <p style="font-size: 0.875rem; color: var(--gray-color);">
                    PDF, Word, Images • Max 10 MB
                </p>
            </div>

            <!-- Grille de fichiers (exemple) -->
            <div class="empty-state">
                <i class="fas fa-folder-open"></i>
                <p>Aucun fichier pour cette classe</p>
                <p style="font-size: 0.875rem;">Les fichiers uploadés apparaîtront ici</p>
            </div>
        </div>
    </div>

    <!-- Onglet Sanctions -->
    <div id="sanctions-tab" class="tab-content">
        <div class="sanctions-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-exclamation-triangle"></i> Suivi des sanctions
                </h2>
                <button class="btn btn-danger" onclick="resetAllSanctions()">
                    <i class="fas fa-undo"></i> Réinitialiser toutes les coches
                </button>
            </div>

            {% if imported_sanctions and students %}
            <div class="sanctions-table-container">
                <table class="sanctions-table">
                    <thead>
                        <tr>
                            <th class="student-column">Élève</th>
                            {% for sanction in imported_sanctions %}
                            <th class="sanction-column">{{ sanction.name }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in students %}
                        <tr>
                            <td class="student-name">{{ student.full_name }}</td>
                            {% for sanction in imported_sanctions %}
                            <td class="sanction-count">
                                <div class="count-controls">
                                    <button class="count-btn decrease" onclick="updateCount({{ student.id }}, {{ sanction.id }}, -1)">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <span class="count-display" data-student="{{ student.id }}" data-sanction="{{ sanction.id }}">
                                        {{ sanctions_data[student.id][sanction.id] }}
                                    </span>
                                    <button class="count-btn increase" onclick="updateCount({{ student.id }}, {{ sanction.id }}, 1)">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% elif not imported_sanctions %}
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Aucun modèle de sanction importé dans cette classe</p>
                <p style="font-size: 0.875rem;">Allez dans <a href="{{ url_for('sanctions.index') }}">Gestion des sanctions</a> pour créer et importer des modèles</p>
            </div>
            {% elif not students %}
            <div class="empty-state">
                <i class="fas fa-user-graduate"></i>
                <p>Aucun élève dans cette classe</p>
                <p style="font-size: 0.875rem;">Ajoutez des élèves dans l'onglet "Élèves" pour commencer le suivi des sanctions</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Variables globales
let editingStudentId = null;

// Gestion des onglets
function showTab(tabName) {
    // Masquer tous les contenus
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });

    // Désactiver tous les boutons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });

    // Afficher le contenu sélectionné
    document.getElementById(tabName + '-tab').classList.add('active');

    // Activer le bouton correspondant
    event.target.closest('.tab-button').classList.add('active');
}

// Changer de classe
function changeClass(classroomId) {
    window.location.href = `{{ url_for('planning.manage_classes') }}?classroom=${classroomId}`;
}

// Afficher/masquer le formulaire d'ajout d'élève
function toggleAddStudentForm() {
    const form = document.getElementById('addStudentForm');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';

    // Réinitialiser le formulaire si on le cache
    if (form.style.display === 'none') {
        resetStudentForm();
    }
}

// Réinitialiser le formulaire
function resetStudentForm() {
    document.getElementById('studentForm').reset();
    editingStudentId = null;
    document.querySelector('#addStudentForm h3').textContent = 'Nouvel élève';
    document.querySelector('#studentForm button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Enregistrer';
}

// Gestion du formulaire d'ajout/modification d'élève
document.getElementById('studentForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const submitButton = e.target.querySelector('button[type="submit"]');
    const originalText = submitButton.innerHTML;

    // Désactiver le bouton et afficher un loader
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';

    const data = {
        classroom_id: {{ selected_classroom_id }},
        first_name: document.getElementById('studentFirstName').value,
        last_name: document.getElementById('studentLastName').value,
        email: document.getElementById('studentEmail').value
    };

    try {
        let url, method;

        if (editingStudentId) {
            // Mode modification
            data.student_id = editingStudentId;
            url = '{{ url_for("planning.update_student") }}';
            method = 'PUT';
        } else {
            // Mode ajout
            url = '{{ url_for("planning.add_student") }}';
            method = 'POST';
        }

        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            showNotification('success', result.message);

            if (editingStudentId) {
                // En mode modification, mettre à jour la carte de l'élève
                updateStudentCard(result.student);
                toggleAddStudentForm();
            } else {
                // En mode ajout, ajouter la nouvelle carte
                addStudentCard(result.student);
                // Réinitialiser le formulaire mais le garder ouvert
                document.getElementById('studentForm').reset();
                document.getElementById('studentFirstName').focus();
            }
        } else {
            showNotification('error', result.message || 'Erreur lors de l\'enregistrement');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur lors de la communication avec le serveur');
    } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
    }
});

// Ajouter une carte d'élève au DOM
function addStudentCard(student) {
    const studentsGrid = document.querySelector('.students-grid');

    // Si c'est le premier élève, remplacer l'état vide
    const emptyState = document.querySelector('.students-section .empty-state');
    if (emptyState) {
        emptyState.remove();
        // Créer la grille si elle n'existe pas
        if (!studentsGrid) {
            const newGrid = document.createElement('div');
            newGrid.className = 'students-grid';
            document.querySelector('.students-section').appendChild(newGrid);
        }
    }

    const studentCard = document.createElement('div');
    studentCard.className = 'student-card';
    studentCard.id = `student-${student.id}`;
    studentCard.style.animation = 'slideIn 0.3s ease';

    studentCard.innerHTML = `
        <div class="student-info">
            <div class="student-avatar">
                ${student.initials}
            </div>
            <div class="student-details">
                <h4>${student.full_name}</h4>
                ${student.email ? `<p>${student.email}</p>` : ''}
            </div>
        </div>
        <div class="student-actions">
            <button class="btn-icon" title="Modifier" onclick="editStudent(${student.id})">
                <i class="fas fa-edit"></i>
            </button>
            <button class="btn-icon danger" title="Supprimer" onclick="deleteStudent(${student.id}, '${student.full_name}')">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;

    const grid = document.querySelector('.students-grid');
    if (grid) {
        grid.appendChild(studentCard);
    }
}

// Mettre à jour une carte d'élève existante
function updateStudentCard(student) {
    const card = document.getElementById(`student-${student.id}`);
    if (card) {
        const avatar = card.querySelector('.student-avatar');
        avatar.textContent = student.initials;

        const details = card.querySelector('.student-details');
        details.innerHTML = `
            <h4>${student.full_name}</h4>
            ${student.email ? `<p>${student.email}</p>` : ''}
        `;

        // Mettre à jour le bouton de suppression avec le nouveau nom
        const deleteBtn = card.querySelector('.btn-icon.danger');
        deleteBtn.setAttribute('onclick', `deleteStudent(${student.id}, '${student.full_name}')`);

        // Animation de mise à jour
        card.style.animation = 'pulse 0.5s ease';
    }
}

// Modifier un élève
async function editStudent(studentId) {
    try {
        const response = await fetch(`{{ url_for("planning.get_student", student_id=0) }}`.replace('0', studentId), {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const result = await response.json();

        if (result.success) {
            // Remplir le formulaire avec les données de l'élève
            document.getElementById('studentFirstName').value = result.student.first_name;
            document.getElementById('studentLastName').value = result.student.last_name;
            document.getElementById('studentEmail').value = result.student.email;

            // Mettre à jour le titre et le bouton
            document.querySelector('#addStudentForm h3').textContent = 'Modifier l\'élève';
            document.querySelector('#studentForm button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Modifier';

            // Stocker l'ID de l'élève en cours de modification
            editingStudentId = studentId;

            // Afficher le formulaire
            document.getElementById('addStudentForm').style.display = 'block';

            // Focus sur le premier champ
            document.getElementById('studentFirstName').focus();
        } else {
            showNotification('error', result.message || 'Erreur lors du chargement des données');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur lors de la communication avec le serveur');
    }
}

// Supprimer un élève
async function deleteStudent(studentId, studentName) {
    if (!confirm(`Êtes-vous sûr de vouloir supprimer ${studentName} ?\n\nCette action supprimera également toutes les notes de cet élève.`)) {
        return;
    }

    try {
        const response = await fetch(`{{ url_for("planning.delete_student", student_id=0) }}`.replace('0', studentId), {
            method: 'DELETE',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const result = await response.json();

        if (result.success) {
            showNotification('success', result.message);

            // Supprimer la carte de l'élève avec une animation
            const studentCard = document.getElementById(`student-${studentId}`);
            if (studentCard) {
                studentCard.style.transition = 'all 0.3s ease';
                studentCard.style.opacity = '0';
                studentCard.style.transform = 'scale(0.9)';

                setTimeout(() => {
                    studentCard.remove();

                    // Vérifier s'il reste des élèves
                    const remainingStudents = document.querySelectorAll('.student-card').length;
                    if (remainingStudents === 0) {
                        // Afficher l'état vide
                        const studentsSection = document.querySelector('.students-section');
                        const emptyState = document.createElement('div');
                        emptyState.className = 'empty-state';
                        emptyState.innerHTML = `
                            <i class="fas fa-user-graduate"></i>
                            <p>Aucun élève dans cette classe</p>
                            <button class="btn btn-primary" onclick="toggleAddStudentForm()">
                                <i class="fas fa-plus"></i> Ajouter le premier élève
                            </button>
                        `;
                        studentsSection.appendChild(emptyState);
                    }
                }, 300);
            }
        } else {
            showNotification('error', result.message || 'Erreur lors de la suppression');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur lors de la communication avec le serveur');
    }
}

// Fonction pour afficher les notifications
function showNotification(type, message) {
    // Créer le conteneur de notifications s'il n'existe pas
    let container = document.querySelector('.notifications-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'notifications-container';
        container.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 1000;';
        document.body.appendChild(container);
    }

    // Créer la notification
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        background-color: ${type === 'success' ? '#D1FAE5' : '#FEE2E2'};
        color: ${type === 'success' ? '#065F46' : '#991B1B'};
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        animation: slideInNotification 0.3s ease;
        max-width: 400px;
    `;

    const icon = document.createElement('i');
    icon.className = `fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}`;

    const text = document.createElement('span');
    text.textContent = message;

    notification.appendChild(icon);
    notification.appendChild(text);
    container.appendChild(notification);

    // Supprimer la notification après 5 secondes
    setTimeout(() => {
        notification.style.animation = 'slideOutNotification 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

// Ajouter les animations CSS
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateY(-20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    @keyframes pulse {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
        100% {
            transform: scale(1);
        }
    }

    @keyframes slideInNotification {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOutNotification {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);

// Fonctions pour la gestion des sanctions
async function updateCount(studentId, sanctionId, delta) {
    const countElement = document.querySelector(`[data-student="${studentId}"][data-sanction="${sanctionId}"]`);
    const currentCount = parseInt(countElement.textContent);
    const newCount = Math.max(0, currentCount + delta); // Ne pas aller en dessous de 0
    
    try {
        const response = await fetch('{{ url_for("planning.update_sanction_count") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                student_id: studentId,
                template_id: sanctionId,
                count: newCount
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            countElement.textContent = result.new_count;
            
            // Mettre à jour les classes CSS selon le nombre
            countElement.className = 'count-display';
            if (result.new_count >= 6) {
                countElement.classList.add('danger');
            } else if (result.new_count >= 3) {
                countElement.classList.add('warning');
            }
            
            // Animation de mise à jour
            countElement.style.transform = 'scale(1.2)';
            setTimeout(() => {
                countElement.style.transform = 'scale(1)';
            }, 200);
        } else {
            showNotification('error', result.message || 'Erreur lors de la mise à jour');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur lors de la communication avec le serveur');
    }
}

async function resetAllSanctions() {
    if (!confirm('Êtes-vous sûr de vouloir remettre toutes les coches à zéro pour cette classe ?\n\nCette action est irréversible.')) {
        return;
    }
    
    try {
        const response = await fetch('{{ url_for("planning.reset_all_sanctions") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                classroom_id: {{ selected_classroom_id }}
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('success', result.message);
            
            // Mettre à jour tous les compteurs à 0 visuellement
            document.querySelectorAll('.count-display').forEach(element => {
                element.textContent = '0';
                element.className = 'count-display'; // Enlever les classes warning/danger
                
                // Animation de réinitialisation
                element.style.backgroundColor = '#D1FAE5';
                element.style.color = '#065F46';
                setTimeout(() => {
                    element.style.backgroundColor = '';
                    element.style.color = '';
                }, 1000);
            });
        } else {
            showNotification('error', result.message || 'Erreur lors de la réinitialisation');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur lors de la communication avec le serveur');
    }
}

// Focus sur le champ prénom au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    const firstNameField = document.getElementById('studentFirstName');
    if (firstNameField && document.getElementById('addStudentForm').style.display !== 'none') {
        firstNameField.focus();
    }
    
    // Appliquer les classes CSS aux compteurs selon leur valeur au chargement
    document.querySelectorAll('.count-display').forEach(element => {
        const count = parseInt(element.textContent);
        if (count >= 6) {
            element.classList.add('danger');
        } else if (count >= 3) {
            element.classList.add('warning');
        }
    });
});
</script>
{% endblock %}
